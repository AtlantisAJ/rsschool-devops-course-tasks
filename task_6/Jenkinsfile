pipeline {
  agent any

  environment {
    IMAGE_NAME = "ghcr.io/YOUR_GITHUB_USERNAME/task6-html-app"
    IMAGE_TAG = "latest"
    REGISTRY_CREDENTIALS = 'github-packages-token'
  }

  triggers {
    githubPush()
  }

  stages {
    stage('Build') {
      steps {
        echo 'No build needed for static HTML.'
      }
    }

    stage('Unit Tests') {
      steps {
        echo 'No tests for static HTML.'
      }
    }

    stage('SonarQube Analysis') {
      steps {
        echo 'Skipping SonarQube for HTML (mock step).'
      }
    }

    stage('Docker Build & Push') {
      steps {
        script {
          docker.withRegistry('https://ghcr.io', REGISTRY_CREDENTIALS) {
            def image = docker.build("${IMAGE_NAME}:${IMAGE_TAG}")
            image.push()
          }
        }
      }
    }

    stage('Deploy with Helm') {
      steps {
        sh '''
          helm upgrade --install task6-html-app ./helm-chart \
            --set image.repository=${IMAGE_NAME} \
            --set image.tag=${IMAGE_TAG}
        '''
      }
    }

    stage('Smoke Test') {
      steps {
        sh '''
          sleep 10
          curl -f http://task6-html-app.default.svc.cluster.local || exit 1
        '''
      }
    }
  }

  post {
    success {
      echo 'Pipeline completed successfully!'
    }
    failure {
      echo 'Pipeline failed!'
    }
  }
}
